<!-- templates/character_creation.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Character Creation - UnscriptedAdventures</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cinzel+Decorative:wght@400;700&display=swap" rel="stylesheet">
    <link href="{{ url_for('static', path='/styles.css') }}" rel="stylesheet">
    <!-- Include Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    {% include 'navbar.html' %}

    <h1>Character Creation</h1>

    <div class="character-creation-container">
        <form class="character-form" id="characterForm">
            <div class="form-columns">
                <!-- Left Column -->
                <div class="form-left">
                    <div class="form-group">
                        <label for="characterName">Character Name:</label>
                        <input type="text" id="characterName" name="characterName" required>
                    </div>
                    <div class="form-group">
                        <label for="characterRace">Race:</label>
                        <select id="characterRace" name="characterRace">
                            {% for race in races %}
                                <option value="{{ race.name }}">{{ race.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="characterClass">Class:</label>
                        <select id="characterClass" name="characterClass">
                            {% for class in classes %}
                                <option value="{{ class.name }}">{{ class.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="characterBackground">Background:</label>
                        <select id="characterBackground" name="characterBackground">
                            {% for background in backgrounds %}
                                <option value="{{ background.name }}">{{ background.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="form-right">
                    <!-- Attributes Section -->
                    <div id="attributesSection">
                        <h2>Attributes</h2>
                        <div class="attribute-box">
                            <label>
                                <i class="fas fa-dumbbell"></i> Strength
                            </label>
                            <div id="strengthDisplay" class="attribute-display">15</div>
                        </div>
                        <div class="attribute-box">
                            <label>
                                <i class="fas fa-running"></i> Dexterity
                            </label>
                            <div id="dexterityDisplay" class="attribute-display">12</div>
                        </div>
                        <div class="attribute-box">
                            <label>
                                <i class="fas fa-heartbeat"></i> Constitution
                            </label>
                            <div id="constitutionDisplay" class="attribute-display">10</div>
                        </div>
                        <div class="attribute-box">
                            <label>
                                <i class="fas fa-brain"></i> Intelligence
                            </label>
                            <div id="intelligenceDisplay" class="attribute-display">13</div>
                        </div>
                        <div class="attribute-box">
                            <label>
                                <i class="fas fa-scroll"></i> Wisdom
                            </label>
                            <div id="wisdomDisplay" class="attribute-display">16</div>
                        </div>
                        <div class="attribute-box">
                            <label>
                                <i class="fas fa-users"></i> Charisma
                            </label>
                            <div id="charismaDisplay" class="attribute-display">14</div>
                        </div>

                        <!-- Total Row -->
                        <div class="attribute-box total-box">
                            <label>
                                <strong>Total:</strong>
                            </label>
                            <div id="totalAttributesDisplay" class="attribute-display">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="button-container">
                <button type="button" id="generateAttributesButton" onclick="generateAttributes()">Generate Attributes</button>
                <button type="button" id="saveButton" onclick="saveCharacter()">Save Character</button>
                <div id="loadingSpinner" class="loading-spinner"></div>
            </div>
        </form>
    </div>

    <script>
        // Function to roll 4d6 and drop the lowest
        function roll4d6DropLowest() {
            const rolls = [1, 2, 3, 4].map(() => Math.floor(Math.random() * 6) + 1);
            rolls.sort((a, b) => a - b);  // Sort rolls to drop the lowest
            return rolls[1] + rolls[2] + rolls[3];  // Sum the highest three rolls
        }

        // Function to update attribute colors based on their values
        function updateAttributeColors() {
            const rootStyles = getComputedStyle(document.documentElement);
            const highColor = rootStyles.getPropertyValue('--high-attribute-color').trim();
            const mediumColor = rootStyles.getPropertyValue('--medium-attribute-color').trim();
            const lowColor = rootStyles.getPropertyValue('--low-attribute-color').trim();

            const attributes = ['strength', 'dexterity', 'constitution', 'intelligence', 'wisdom', 'charisma'];
            attributes.forEach(attr => {
                const display = document.getElementById(attr + 'Display');
                const value = parseInt(display.textContent);
                let bgColor;
                if (value >= 16) {
                    bgColor = highColor;
                } else if (value >= 13) {
                    bgColor = mediumColor;
                } else {
                    bgColor = lowColor;
                }
                display.style.backgroundColor = bgColor;
            });
        }

        // Function to calculate the total of all attributes
        function calculateTotalAttributes() {
            const attributes = ['strength', 'dexterity', 'constitution', 'intelligence', 'wisdom', 'charisma'];
            let total = 0;
            attributes.forEach(attr => {
                const value = parseInt(document.getElementById(attr + 'Display').textContent);
                total += value;
            });
            document.getElementById('totalAttributesDisplay').textContent = total;
        }

        // Function to generate attributes and update colors and total
        function generateAttributes() {
            document.getElementById('strengthDisplay').textContent = roll4d6DropLowest();
            document.getElementById('dexterityDisplay').textContent = roll4d6DropLowest();
            document.getElementById('constitutionDisplay').textContent = roll4d6DropLowest();
            document.getElementById('intelligenceDisplay').textContent = roll4d6DropLowest();
            document.getElementById('wisdomDisplay').textContent = roll4d6DropLowest();
            document.getElementById('charismaDisplay').textContent = roll4d6DropLowest();

            updateAttributeColors(); // Update colors after generating attributes
            calculateTotalAttributes(); // Calculate and display the total
        }

        // Function to validate the character name
        async function validateCharacterName(name) {
            const response = await fetch(`/check_character_name/${name}`);
            const data = await response.json();
            return data.exists; // Returns true if name exists, false otherwise
        }

        // Function to save character data
        async function saveCharacter() {
            const characterName = document.getElementById('characterName').value;

            // Check if character name already exists
            const nameExists = await validateCharacterName(characterName);
            if (nameExists) {
                alert('Character name already exists. Please choose a different name.');
                return; // Stop the save function if name exists
            }

            const saveButton = document.getElementById('saveButton');
            const loadingSpinner = document.getElementById('loadingSpinner');

            // Collect character data
            const characterData = {
                name: document.getElementById('characterName').value,
                race: document.getElementById('characterRace').value,
                class: document.getElementById('characterClass').value,
                background: document.getElementById('characterBackground').value,
                strength: document.getElementById('strengthDisplay').textContent,
                dexterity: document.getElementById('dexterityDisplay').textContent,
                constitution: document.getElementById('constitutionDisplay').textContent,
                intelligence: document.getElementById('intelligenceDisplay').textContent,
                wisdom: document.getElementById('wisdomDisplay').textContent,
                charisma: document.getElementById('charismaDisplay').textContent
            };

            // Show the loading spinner and disable the button
            saveButton.disabled = true;
            loadingSpinner.style.display = 'inline-block';

            // Send data to the FastAPI backend
            fetch('/save_character', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(characterData)
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);  // Notify the user that the character was saved
                document.getElementById('characterForm').reset(); // Clear the form
                generateAttributes(); // Generate new attributes
            })
            .catch(error => console.error('Error:', error))
            .finally(() => {
                // Hide the loading spinner and re-enable the button
                loadingSpinner.style.display = 'none';
                saveButton.disabled = false;
            });
        }

        // Automatically generate attributes when the page loads
        window.onload = generateAttributes;
    </script>
</body>
</html>
